<!--
  ~ This file was last modified at 2022.01.24 22:44 by Victor N. Skurikhin.
  ~ This is free and unencumbered software released into the public domain.
  ~ For more information, please refer to <http://unlicense.org>
  ~ Алгоритм работы CMS GC, G1 GC. Часть 2..html
  ~ $Id$
  -->

<!DOCTYPE html>
<!-- saved from url=(0068)http://sannystark.github.io/java/jvm/gc/2015/12/23/gc-jvm-part3.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Алгоритм работы CMS GC, G1 GC. Часть 2.</title>
  <meta name="description" content="И на закуску, приглашаю на сцену CMS GC, и его усовершенствованного брата G1.">

	<link rel="shortcut icon" href="http://sannystark.github.io/favicon.ico?" type="image/x-icon">
	<link rel="icon" href="http://sannystark.github.io/favicon.ico" type="image/x-icon">

  <link rel="stylesheet" href="./Алгоритм работы CMS GC, G1 GC. Часть 2._files/main.css">
  <link rel="canonical" href="http://sannystark.github.io/java/jvm/gc/2015/12/23/gc-jvm-part3.html">
  <link rel="alternate" type="application/rss+xml" title="Блог умелого разработчика" href="http://sannystark.github.io/feed.xml">
<script type="text/javascript" async="" src="./Алгоритм работы CMS GC, G1 GC. Часть 2._files/embed.js"></script><link rel="prefetch" as="style" href="https://c.disquscdn.com/next/embed/styles/lounge.7ab903feba7624935283ca4c7d8c7203.css"><link rel="prefetch" as="script" href="https://c.disquscdn.com/next/embed/common.bundle.d53d00706a584180a3368c8e414318a7.js"><link rel="prefetch" as="script" href="https://c.disquscdn.com/next/embed/lounge.bundle.67f9fd26b5922562ba93be9d9b520b54.js"><link rel="prefetch" as="script" href="https://disqus.com/next/config.js"><script async="" id="dsq_recs_scr" src="./Алгоритм работы CMS GC, G1 GC. Часть 2._files/recommendations.js"></script><link rel="prefetch" as="style" href="https://c.disquscdn.com/next/recommendations/styles/recommendations.10022a97346f1c6e3798931bbd8e4bb5.css"><link rel="prefetch" as="script" href="https://c.disquscdn.com/next/recommendations/common.bundle.a3659a8e961f4dff2575f07c23268b7f.js"><link rel="prefetch" as="script" href="https://c.disquscdn.com/next/recommendations/recommendations.bundle.926bc472e4859a48daa346b4ba2ab4f4.js"><link rel="prefetch" as="script" href="https://disqus.com/next/config.js"><script src="./Алгоритм работы CMS GC, G1 GC. Часть 2._files/alfie_v4.63f1ab6d6b9d5807dc0c94ef3fe0b851.js" async="" charset="UTF-8"></script></head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="http://sannystark.github.io/">Блог умелого разработчика</a>

    <nav class="site-nav">
      <a href="http://sannystark.github.io/java/jvm/gc/2015/12/23/gc-jvm-part3.html#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"></path>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"></path>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"></path>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="http://sannystark.github.io/about/">Обо мне</a>
          
        
          
          <a class="page-link" href="http://sannystark.github.io/archive/">Архив</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope="" itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Алгоритм работы CMS GC, G1 GC. Часть 2.</h1>
    <p class="post-meta"><time datetime="2015-12-23T18:00:00+02:00" itemprop="datePublished">Dec 23, 2015</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>И на закуску, приглашаю на сцену CMS GC, и его усовершенствованного брата G1.
<!--more--></p>

<p>В этой статье мы рассмотрим два инкрементальных сборщиков мусора CMS и G1, которые нацелены на уменьшение времени SWT пауз, и увеличить производительность для работы с большими объемами в памяти. Но как мы знаем по треугольнику оптимизации, уменьшая время SWT пауз в данном случае жертвовать придется пропускной способностью. Каждый из сборщиков добивается производительности по разному, давайте посмотрим как.</p>

<h2 id="cms-gc">CMS GC</h2>

<p>CMS (Concurrent Mark Sweep) - инкрементальный, конкурентный сборщик мусора который появился почти в одно время с Parralell GC. Давайте разберемся, что такое инкрементальный а что такое конкурентный. Инкрементальный означает что сборка мусора, происходит маленькими порциями, во время работы вашего приложения в бэк-граунде, то есть в риал-тайме, в следствии этого, уменьшение STW пауз(к сожалению убрать паузы совсем пока не удалось). И достигается это за счет конкурентных потоков, которые постоянно хотят найти и убрать мусор. Я думаю всем знакомый случай, когда вы сидите за завтраком в закусочной, а к вам постоянно пристает уборщица и просит убрать ноги что бы помыть полы. Подобным образом работает и CMS, вы едите, а вас периодически, и вроде бы не навязчиво, подметают или моют полы.</p>

<p>Как включить : -XX:+UseConcMarkSweepGC.</p>

<h4 id="section">Принципы работы</h4>

<p>Начнем с того что мы уже знаем. Этот сборщик мусора использует то же разделение памяти что и предыдущих два - Edem, S-0, S-1, Tunered. Его цель решить проблему долгих пауз. Как правило эти паузы очень хорошо заметны в старшем поколении, так как оно значительно больше по размерам чем младшее, соответственно отслеживание и чистка мертвых объектов по времени больше. Поэтому разработчики пошли путем улучшения именно сборки мусора в старшем поколении.</p>

<p>В младшем поколении работает все тот же minor цикл, а со старшим поколением работает так называемый major цикл(не путать с полным циклом), который нацелен на оперирование только старшим поколением. К тому же Tunered поколению не обязательно быть до конца заполненным, что бы запустился major цикл, вся работа происходит во время работающего приложения.</p>

<p>Давайте детально рассмотрим это цикл.</p>

<p>Начинается все с короткой остановки программы для пометки так называемых корневых объектов. После клиентская программа возобновляется, и параллельно с ней запускается один(несколько) потоков, который индексирует живые объекты используя корневые точки.</p>

<p>Конечно куча не постоянна, и за время работы программы, некоторые индексы стали не актуальны, поэтому происходит еще одна остановка, для повторного сканирования/индексирования объектов.</p>

<p>После программа возобновляется и сборщик производит очистку памяти от мертвых объектов в нескольких параллельных потоках. Но есть один нюанс, после очистки объектов из старшего поколения, упаковка(сжатие) происходить не будет, так как это проблематично осуществить во время работающего приложения, поэтому со временем память становиться фрагментированной. В связи с этим GC должен поддерживать особый список с хранением адресов участков свободной памяти (free lists). То есть при создании нового объекта, необходимо обойти этот список, что накладывает дополнительные ресурсы. Поэтом создание объекта дорогостоящая операция данном сборщике мусора.</p>

<p>Так же это сборщик мусора имеет интеллект и проявляется он в сборке статистики по SWT между major и minor циклами и пытается оптимизировать их во времени (разнести), что бы предотвратить скопление пауз в одном промежутке времени.</p>

<p>Но что если сборщик мусора не успевать очистить Tunered область, в этом случаи приложение приостанавливается и запускается сборка в последовательном режиме. Такая ситуация называется - concurrent mode failure, то есть сбой конкурентного режима.</p>

<h4 id="section-1">Плюсы и минусы</h4>

<p>Как было описано выше, это конкурирующий, инкрементальный сборщик мусора, нацеленный на минимизацию простоя приложения. Для некоторых приложений это является критическим фактором. И так как он работает в фоновом режиме, пропускная способность самого приложения немного падает, так как и приложение, и сборщик мусора, будут конкурировать за ресурсы. Так же отсутствие уплотнения(сжатия) фрагментирует память, что заставляет нас выделять больше памяти (20-30 %) для этого.</p>

<p>Но такой сборщик может подойти приложениям, использующим большой объем долгоживущих данных. В этом случае некоторые его недостатки опускаются.</p>

<h4 id="section-2">Настройка</h4>

<p>Те же настроки что и в Parralell GC.</p>

<p>-XX:CMSInitiatingOccupancyFraction=? - пороговое значение наполения Tunered области, для запуска цикла полной сборки мусора</p>

<h2 id="g1-gc">G1 GC</h2>

<p>G1 (Garbage First) - один из молодых(последних) сборщиков мусора. Он не является наследником предыдущих GC, он не добавляет еще параллельности или конкурентности, он не разбивает на еще большее количество областей память, он кардинально меняет подход к самой сборке.</p>

<p>Это самый первый конкурент CMS GC, который позиционирует себя как сборщик мусора для работы с большими кучами ( &gt; 4Гб) для которого важна сохранность времени отклика и предсказуемость. Компания Oralce хочет выдвинуть его как стоящую замену CMS и поставить его стандартным сборщиком мусора для серверных конфигурация в 9-й версии.</p>

<p>Как включить : -XX:+UseG1GC</p>

<h4 id="section-3">Принципы работы</h4>

<p>Первое что бросается к глаза, так это организация кучи. Здесь память разбивается на множество участков от 1-32 Мб, и каждый из этих участков можеть быть как и Edem, S-0, S-1 так и Tunered. Исключением лишь являются громадные участки (humongous), которые создаются объединением простых регионов.</p>

<p><img src="./Алгоритм работы CMS GC, G1 GC. Часть 2._files/G1.png" alt="pic"></p>

<p>Малые сборки работаю с младшими поколениями, и выполняются они периодически, все так же для переноса выживших из Edem в S-0, S-1 или Tunered. Никуда нам не деться от SWT пауз, которые присутствуют и здесь, но есть кардинальное отличие, сборщик мусора сам решает над каким из младших поколений ему работать, исходя из заданного времени и максимально выгодного результата. Поэтому его и прозвали Garbage First - то есть - мусор превыше всего.</p>

<p>Работа со старшим поколением называется смешанным циклом, и она так же отличается от CMS маленькой особенностью. В G1 существует процесс, называемый циклом пометки (marking cycle), который работает параллельно с основным приложением и составляет список живых объектов. Подобный процесс присутствует и в CMS, но немного отличается в конце.</p>

<ul>
  <li>Маркировка корневых объектов полученных из малых циклов (Initial mark), остановка приложения</li>
  <li>Параллельная пометка живых объектов (Concurrent marking), во время работающего приложения</li>
  <li>Остановка приложения и повторный поиск неучтенных объектов (Remark)</li>
  <li>Очистка от мусора при остановленном приложении, поиск пустых регионов для новых объектов параллельно с работающим приложением</li>
</ul>

<p>После G1 переключается в режим смешанной сборки. Это означает, что к младшим регионам, подлежащим очистке, подселяют некоторое количество из старшего региона. Делается это для того что бы оптимизировать и уложится в заданное время сборки, а размеры подселяемых участков и их количество коррелируется статистикой собранной на предыдущих циклах. После того как GC собрал достаточно мусора, он переключается в режим малой сборки.</p>

<p>Может произойти ситуация, что в процессе очисти не останется памяти для винивших объектов, в таком случаи запускается полный сборщик мусора и приложение приостанавливается.</p>

<p>Следует упомянуть о гигантских объектах (humongous objects) - те которые не помещаются в один регион. Обработка этих объектов следует таким правилам : 
 - такой объект никогда не копируется/перемещается между регионами
 - он может быть удален как во время цикла маркировки, так и во время цикла очистки
 - к таким регионам никогда никого не подселяют</p>

<h4 id="section-4">Плюсы и минусы</h4>

<p>Цель этого сборщика мусора сделать эти сборки настолько предсказуемыми насколько возможно. Так же он решает проблему фрагментации памяти. Конечно же что бы всего этого достичь, необходимо жертвовать пропускной способность(нагрузкой на CPU). На данном этапе я думаю это достойная замена CMS для северных приложений, а так же как плацдарм для экспериментов.</p>

<h4 id="section-5">Настройка</h4>

<ul>
  <li>-XX:ParallelGCThreads=? - количество потоков для сборки мусора</li>
  <li>-XX:ConcGCThreads=? - количество потоков для цикла пометок</li>
  <li>-XX:G1HeapRegionSize=? - размер области региона</li>
</ul>

<p>Вот мы и познакомились со всеми сборщиками мусора в виртуальной машине HotSpot. Надеюсь эти статьи пролили свет на многие аспекты работы GC а так же добавило понимая, что же там все таки твориться под капотом.</p>

<p>В следующей статье я расскажу, какие есть проблемы у JVM (OutOFMemory etc), как их можно решать, и какие есть способы трекинга и оптимизации JVM.</p>

  </div>
  
	<div id="disqus_recommendations" style="margin-bottom: 12px;"><iframe id="dsq-app8596" name="dsq-app8596" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="./Алгоритм работы CMS GC, G1 GC. Часть 2._files/saved_resource.html" style="width: 100% !important; border: none !important; overflow: hidden !important; height: 0px !important; display: inline !important; box-sizing: border-box !important;" horizontalscrolling="no" verticalscrolling="no"></iframe></div><div id="disqus_thread"><iframe id="dsq-app797" name="dsq-app797" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="./Алгоритм работы CMS GC, G1 GC. Часть 2._files/saved_resource(1).html" style="width: 1px !important; min-width: 100% !important; border: none !important; overflow: hidden !important; height: 394px !important;" horizontalscrolling="no" verticalscrolling="no"></iframe></div>
	    <script type="text/javascript">
	        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
	        var disqus_shortname = 'sannystark'; // required: replace example with your forum shortname
	        // var disqus_developer = 1; // Comment out when the site is live
	        var disqus_identifier = "/java/jvm/gc/2015/12/23/gc-jvm-part3.html";
	        //var disqus_developer = 1;

	        /* * * DON'T EDIT BELOW THIS LINE * * */
	        (function() {
	            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	        })();
	    </script>
	    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	    
	

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Блог умелого разработчика</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Блог умелого разработчика</li>
          <li><a href="mailto:stasenfox@gmail.com">stasenfox@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/sannystark"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path></svg>
</span><span class="username">sannystark</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/stasenfox"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"></path></svg>
</span><span class="username">stasenfox</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Блог о програмировании, алгоритмах, уязвимостях, безисходности и черной материи
</p>
      </div>
    </div>

  </div>

</footer>


  


<iframe style="display: none;" src="./Алгоритм работы CMS GC, G1 GC. Часть 2._files/saved_resource(2).html"></iframe><iframe style="display: none;" src="./Алгоритм работы CMS GC, G1 GC. Часть 2._files/saved_resource(3).html"></iframe></body></html>